<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/foundation/6.2.1/foundation.min.css" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-rc1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/foundation/6.2.1/foundation.min.js"></script>
  <script src="application.js"></script>
  <script src="500px.js"></script>

  <title>GOOGLE MAPS X 500PX MASHUP</title>
</head>
<body>
  <h1>GOOGLE MAPS vs 500PX</h1>
  <div id="map">
  </div>

  <script>

      function showMap() {

        var mapDiv = document.getElementById('map');
        var map = new google.maps.Map(mapDiv, {
          center: {
              lat: 43.644645,
              lng: -79.394999
          },
          zoom: 11
        });

        getLocation(map);
      }


      function getLocation(map) {

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
              pos = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude
              };
              var lat = position.coords.latitude;
              var lng = position.coords.longitude;
              map.setZoom(13);
              fetchImages(lat,lng,pos,map);
          });
        }
      }


      function fetchImages(lat,lng,pos,map){
        // 500px API
        var api_call_url = "https://api.500px.com/v1/photos/search?consumer_key=wpPbFbHMVIuEjBGXXetIuSKeXgvoV33IwluXvqGw&geo=" + lat + "," + lng + ",20km";
        $.get( api_call_url, function( data ) {
          console.log( data["[photos]"] );
          var photos = data["photos"];
        });
        buildMap(pos,map,photos);
      }

      function buildMap(pos,map,photos){

        var mapDiv = document.getElementById('map');

        var your_marker = new google.maps.Marker({
          position: pos,
          title: "You!"
        });

        // To add the marker to the map, call setMap();
        your_marker.setMap(map);

        var num_photos = photos.length;


        // Shapes define the clickable region of the icon. The type defines an HTML
        // <area> element 'poly' which traces out a polygon as a series of X,Y points.
        // The final coordinate closes the poly by connecting to the first coordinate.
        var shape = {
            coords: [1, 1, 1, 20, 18, 20, 18, 1],
            type: 'poly'
        };

        for (var i = 1; i < photos.length; i++) {
         (function(photo) {

           var image = {
               url: photo["image_url"],
               size: new google.maps.Size(140, 140),
               // The origin for this image is (0, 0).
               origin: new google.maps.Point(0, 0),
               // The anchor for this image is the base of the flagpole at (0, 32).
               anchor: new google.maps.Point(140, 140)
           };

           var marker = new google.maps.Marker({
               position: {
                   lat: photo["latitude"],
                   lng: photo["longitude"]
               },
               map: map,
               icon: image,
               shape: shape,
               title: photo["name"],
               zIndex: photo["id"]
           });


           // Create the info window
           var infowindow = new google.maps.InfoWindow({
             content: "<strong><a href='/trucks/"+truck[4]+"'>"+truck[8]+"</a></strong><br />"+truck[0]+"<br />"+truck[5]+" to "+truck[6]+"<br /><a href='https://maps.google.com?saddr=Current+Location&daddr="+truck[7]+"' target='_blank'/>GET DIRECTIONS  &rarr;</a>"
           });

           // Add event listener for click
           google.maps.event.addListener(marker, 'click', function() {
             infowindow.open(map,marker);
           });
         })(trucks[i]);
        }


        if (num_trucks == 0) {
           $("#map-notifications").text("There are no food trucks operating today. :(");
         }
         if (num_trucks == 1) {
           $("#map-notifications").text("Found one food truck.");
         }
         if (num_trucks > 1) {
           $("#map-notifications").text("We found " + num_trucks + " food trucks!");
         }

      }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBYNOo2ctuuBEv0TANRMBGwE2thFIUNxYU&callback=showMap" async defer></script>
  <!-- localhost key -->
</body>
</html>
